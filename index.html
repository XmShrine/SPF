<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPF</title>
    
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']], 
            displayMath: [['$$', '$$'], ['\\[', '\\]']] 
          },
          svg: {
            fontCache: 'global'
          },
          options: {
            renderActions: {
              assistiveMml: [], 
              addMenu: [],
              sre: []
            }
          }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/JavaScript" src="SPF.js"></script>

    <style>
        /* ----------------------------------- */
        /* 基础与排版 - 苹果暗黑设计语言 */
        /* ----------------------------------- */
        :root {
            --apple-bg: #1e1e1e; 
            --apple-card-bg: #2c2c2e;
            --apple-border: #444444; 
            --apple-shadow: rgba(0, 0, 0, 0.4); 
            --apple-primary: #0a84ff; 
            --apple-text-color: #f0f0f0;
            --apple-secondary-text: #aeaeb3;
            --apple-radius: 12px;
            --apple-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --input-box-bg: #3c3c3e;
            --select-bg: #3c3c3e; /* 选择菜单背景 */
        }

        body {
            font-family: var(--apple-font);
            background-color: var(--apple-bg);
            color: var(--apple-text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 卡片风格 */
        .card {
            background-color: var(--apple-card-bg);
            border-radius: var(--apple-radius);
            padding: 25px;
            box-shadow: 0 8px 30px var(--apple-shadow); 
            border: 1px solid var(--apple-border);
            transition: box-shadow 0.3s ease, border-color 0.3s;
        }

        .card:hover {
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.5);
            border-color: #555555;
        }
        
        /* ----------------------------------- */
        /* 输出区域 (标题和复制功能) */
        /* ----------------------------------- */
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--apple-border);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .output-area h2 {
            font-size: 20px;
            font-weight: 500;
            margin: 0;
        }

        .copy-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* 复制按钮 */
        #copyBtn {
            background-color: var(--apple-primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }

        #copyBtn:hover {
            background-color: #2b9aff;
        }

        #copyBtn:active {
            opacity: 0.8;
        }
        
        /* 选择菜单 (上拉菜单/下拉菜单样式) */
        #copyModeSelect {
            background-color: var(--select-bg);
            color: var(--apple-text-color);
            border: 1px solid var(--apple-border);
            border-radius: 6px;
            padding: 7px 10px;
            font-size: 14px;
            appearance: none; /* 移除默认样式 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23aeaeb3' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 25px; /* 留出空间给箭头 */
            cursor: pointer;
        }

        #copyModeSelect:focus {
            outline: none;
            border-color: var(--apple-primary);
        }

        .output-box {
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background-color: var(--input-box-bg);
            border: 1px solid var(--apple-border);
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.6;
            color: var(--apple-text-color);
        }

        /* ----------------------------------- */
        /* 输入控件和状态样式 */
        /* ----------------------------------- */
        .input-area {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }
        
        /* N值输入框的容器 (新样式) */
        #n-input-container {
            display: flex;
            align-items: center;
            /* 模仿 iOS Setting 的左右间距和垂直居中 */
            gap: 15px; 
            padding: 15px 0; 
            margin-bottom: 20px; /* 与多项式输入框保持间距 */
            border-bottom: 1px solid var(--apple-border);
        }

        #n-input-container label {
            /* 确保标签颜色正确，且占据左侧空间 */
            color: var(--apple-text-color);
            font-weight: 500;
        }

        #polyTotalNum {
            /* 模仿 iOS 的小输入框样式 */
            width: 70px; /* 稍微窄一些 */
            padding: 8px 12px;
            background-color: var(--input-box-bg);
            border: 1px solid var(--apple-border);
            border-radius: 8px;
            font-size: 16px;
            color: var(--apple-primary); /* 将 N 值颜色设置为强调色 */
            text-align: right;
            transition: border-color 0.2s, box-shadow 0.2s;
            margin-left: auto; /* 推到最右边 */
        }
        
        #polyTotalNum:focus {
            border-color: var(--apple-primary);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
        }

        /* 禁用状态的样式 */
        #polyInput:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 其他区域 CSS 保持不变 (为简洁省略) */
        .header-card {text-align: center;}
        .header-card h1 {font-size: 28px;font-weight: 600;margin: 0 0 5px 0;}
        .header-card p {color: var(--apple-secondary-text);font-size: 16px;margin: 0;}
        #polyInput {flex-grow: 1;width: 100%;min-height: 120px;resize: vertical;padding: 15px;background-color: var(--input-box-bg);border: 1px solid var(--apple-border);border-radius: 8px;font-size: 16px;font-family: monospace;color: var(--apple-text-color);transition: border-color 0.2s, box-shadow 0.2s;outline: none;}
        #polyInput:focus {border-color: var(--apple-primary);box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);}
        .action-button {background-color: var(--apple-primary);color: black;border: none;border-radius: 8px;padding: 12px 20px;font-size: 16px;font-weight: 600;cursor: pointer;display: flex;flex-direction: column;align-items: center;justify-content: center;transition: background-color 0.2s, transform 0.1s, opacity 0.2s;height: 120px;min-width: 80px;}
        .action-button .icon, .action-button .text {color: white;}
        .action-button:hover {background-color: #2b9aff;}
        .action-button:active {transform: scale(0.98);}
        .action-button .icon {font-size: 20px;line-height: 1;margin-bottom: 5px;}
        .action-button .text {font-size: 14px;}
        .mode-selector {padding-bottom: 15px;border-bottom: 1px solid var(--apple-border);margin-bottom: 15px;display: flex;align-items: center;}
        .mode-selector label:first-child {font-weight: 600;margin-right: 20px;color: var(--apple-text-color);white-space: nowrap;}
        .mode-buttons {display: inline-flex;background-color: var(--input-box-bg);border: 1px solid var(--apple-border);border-radius: 9px;overflow: hidden;flex-shrink: 1;}
        .mode-buttons input[type="radio"] {display: none;}
        .mode-buttons label {padding: 8px 15px;font-size: 14px;cursor: pointer;background-color: transparent;color: var(--apple-secondary-text);transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;border-right: none;font-weight: 500;text-align: center;min-width: 80px;}
        .mode-buttons input[type="radio"]:checked + label {background-color: var(--apple-primary);color: white;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);}
        .info-button {position: fixed;bottom: 30px;right: 30px;width: 48px;height: 48px;border-radius: 50%;background-color: var(--apple-primary);color: white;font-size: 24px;font-weight: 600;border: none;cursor: pointer;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);transition: background-color 0.2s, transform 0.2s;z-index: 100;}
        .info-button:hover {background-color: #2b9aff;transform: translateY(-2px);}
        .modal {display: none;position: fixed;z-index: 200;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgba(0,0,0,0.6);backdrop-filter: blur(8px);}
        .modal-content {margin: 10% auto;padding: 30px;width: 80%;max-width: 600px;position: relative;background-color: var(--apple-card-bg);animation-name: animatetop;animation-duration: 0.4s;}
        @keyframes animatetop {from {top: -300px; opacity: 0}to {top: 0; opacity: 1}}
        .close-button {color: var(--apple-secondary-text);float: right;font-size: 36px;font-weight: bold;transition: color 0.2s;line-height: 1;}
        .close-button:hover,.close-button:focus {color: var(--apple-text-color);text-decoration: none;cursor: pointer;}
        .modal-body h2 {color: var(--apple-primary);}
        .modal-body hr {border: none;border-top: 1px solid var(--apple-border);margin: 10px 0 20px 0;}
        .modal-body pre {background-color: var(--input-box-bg);padding: 10px;border-radius: 6px;overflow-x: auto;font-size: 14px;margin: 10px 0;color: white;border: 1px solid var(--apple-border);}
        .modal-body ul {padding-left: 20px;margin-top: 5px;}
    </style>
</head>
<body>

    <div class="container">
        <header class="card header-card">
            <h1>对称多项式初等分解</h1>
            <p>(C++ 30 小组)</p>
        </header>

        <div class="main-content card">
            
            <div class="mode-selector">
                <label>选择分解模式:</label>
                <div class="mode-buttons">
                    <input type="radio" id="mode1" name="polyMode" value="1" checked>
                    <label for="mode1">经典模式 (1)</label>
                    
                    <input type="radio" id="mode2" name="polyMode" value="2">
                    <label for="mode2">乘积模式 (2)</label>
                    
                    <input type="radio" id="mode3" name="polyMode" value="3">
                    <label for="mode3">加和模式 (3)</label>
                </div>
            </div>

            <div id="n-input-container" style="display: none;">
                <label for="polyTotalNum">输入变量总数 N:</label>
                <input type="number" id="polyTotalNum" min="1" placeholder="N" value=""> 
            </div>

            <div class="input-area">
                <textarea id="polyInput" placeholder="在此输入对称多项式..." rows="5" disabled></textarea> 
                <button id="submitBtn" class="action-button">
                    <span class="icon">⏎</span>
                    <span class="text">分解</span>
                </button>
            </div>
            
        </div>

        <div class="output-area card">
            
            <div class="output-header">
                <h2>分解结果 (支持 $\LaTeX$ 渲染)</h2>
                <div class="copy-controls">
                    <select id="copyModeSelect">
                        <option value="latex">复制 $\LaTeX$</option>
                        <option value="raw">复制原始</option>
                    </select>
                    <button id="copyBtn" title="复制结果">复制</button>
                </div>
            </div>
            
            <div id="polyOutput" class="output-box" data-mathjax-ignore>
                等待输入...
            </div>
        </div>
    </div>

    <button id="infoBtn" class="info-button">?</button>

    <div id="infoModal" class="modal">
        <div class="modal-content card">
            <span class="close-button">&times;</span>
            <div class="modal-body">
                <h2>目前更新进度：</h2>
                <hr>
                <p>经典模式完成，可复制对应分解，乘积/加和有待完善</p>
            </div>
        </div>
    </div>

    <script>
        // 全局变量，用于存储 DealPoly 返回的原始结果字符串和 N 值
        let temp = "等待输入..."; 
        let tempPoly = null; // 用于存储多项式对象
        let polyTotalNum = 0; // 存储 N 的值
        
        // *** DOM 元素引用 ***
        const polyInput = document.getElementById('polyInput');
        const submitBtn = document.getElementById('submitBtn');
        const polyOutput = document.getElementById('polyOutput');
        const modeRadios = document.querySelectorAll('input[name="polyMode"]');
        const copyBtn = document.getElementById('copyBtn');
        const copyModeSelect = document.getElementById('copyModeSelect');
        const infoBtn = document.getElementById('infoBtn');
        const infoModal = document.getElementById('infoModal');
        const closeButton = document.querySelector('.close-button');
        
        // 新增的 N 值输入元素
        const nInputContainer = document.getElementById('n-input-container');
        const nInput = document.getElementById('polyTotalNum');

        // 初始化时，如果默认是模式1，则启用多项式输入
        if (document.getElementById('mode1').checked) {
            polyInput.disabled = false;
        }


        // *** 核心逻辑函数 ***

        // 辅助函数：根据 nInput 的值控制 polyInput 的启用/禁用状态
        function updatePolyInputState() {
            const currentMode = document.querySelector('input[name="polyMode"]:checked').value;
            
            if (currentMode === '1') {
                // 模式1（经典模式）：始终启用
                polyInput.disabled = false;
                polyTotalNum = 0; // 经典模式下 n 无意义
            } else {
                // 模式2/3（乘积/加和模式）：依赖 n 的值
                const nValue = parseInt(nInput.value);
                
                if (nValue > 0) {
                    polyInput.disabled = false;
                    polyTotalNum = nValue;
                } else {
                    polyInput.disabled = true;
                    polyTotalNum = 0;
                    if (nInput.value.trim() !== '') {
                         // 只有当N输入框被修改但值无效时才提示
                         polyOutput.innerHTML = '<span style="color: var(--apple-secondary-text);">请在下方输入框中输入大于 0 的变量总数 N。</span>';
                         if (window.MathJax) {
                             MathJax.typesetPromise([polyOutput]).catch((err) => console.log('MathJax Typeset Error: ' + err.message));
                         }
                    }
                }
            }
        }
        
        /**
         * 辅助函数：将多项式单项式转换为 LaTeX 格式
         */
        function MonoToTex(mono) {
            var result = "";
            // 确保系数不为 1 时显示，如果为 -1 则只显示 -
            if (mono.coeff !== 1) {
                if (mono.coeff === -1 && mono.variable.some(v => v !== 0)) {
                    result = "-";
                } else {
                    result = `${mono.coeff}`;
                }
            } else if (mono.coeff === -1 && !mono.variable.some(v => v !== 0)) {
                 result = "-1"; // 常数 -1
            }
            
            // 拼接变量
            for (var i = 0; i < mono.variable.length; i++) {
                if (mono.variable[i] !== 0) {
                    result = result + `\\sigma_{${i+1}}`;
                    if (mono.variable[i] > 1) {
                        result = result + `^{${mono.variable[i]}}`;
                    }
                }
            }
            
            // 如果系数是 1，但变量部分为空（常数项 1），则手动加上 1
            if (mono.coeff === 1 && result === "") {
                result = "1";
            }
            
            return result;
        }
        
        /**
         * 辅助函数：将多项式对象转换为 LaTeX 块级公式
         */
        function PolyToTex(poly) {
            if (!poly || !poly.arr || poly.arr.length === 0) return "$$0$$";

            var result = "$$";
            for (var i = 0; i < poly.arr.length; i++) {
                const mono = poly.arr[i];
                const monoTex = MonoToTex(mono);
                
                // 处理加号：如果不是第一项且系数大于 0，则添加 + 号
                if (i > 0 && mono.coeff > 0) {
                    result = result + "+";
                }
                
                result = result + monoTex;
            }
            result = result + "$$";
            return result;
        }

        /**
         * 核心：处理输入并调用外部 SPF 库
         */
        function DealPoly(input, mode) {
            console.log(`处理输入: "${input}", 模式: ${mode}, N=${polyTotalNum}`);
            
            if (!input.trim()) {
                return "请输入一个多项式";
            }
            
            // 假设 SPF.js 中的函数存在
            if (typeof SPF !== 'function' || typeof "".toPolynomial !== 'function') {
                return "错误：外部依赖 SPF.js 或 toPolynomial() 未加载。";
            }

            // 调用外部函数，传入 N 值
            try {
                // 假设 input.toPolynomial() 返回一个多项式对象
                const inputPoly = input.toPolynomial(); 
                tempPoly = SPF(inputPoly, polyTotalNum); 
            } catch (e) {
                console.error("Polynomial processing error:", e);
                return `处理多项式时出错: ${e.message || e}`;
            }

            
            // 示例输出，MathJax 默认支持 $...$ 和 $$...$$
            const sampleOutput = {
                1: (tempPoly==false) ? "$\\text{Not a Sym Polynomial}$" : PolyToTex(tempPoly),
                2: `乘积模式 (${polyTotalNum} 变量) 结果：$$\\frac{1}{2}\\sigma_1 (\\sigma_1^2 - 3\\sigma_2) + \\sigma_3$$`,
                3: `加和模式 (${polyTotalNum} 变量) 结果：$$(\\sigma_1 - x_1)(\\sigma_1 - x_2)\\dots(\\sigma_1 - x_{N})$$`
            };
            
            return sampleOutput[mode] || "模式错误或处理失败。";
        }

        // 核心函数：处理输入并更新显示
        function processInput() {
            // 只有在多项式输入框启用时才执行分解
            if (polyInput.disabled) {
                const currentMode = document.querySelector('input[name="polyMode"]:checked').value;
                if (currentMode !== '1') {
                    polyOutput.innerHTML = '<span style="color: var(--apple-secondary-text);">请先在上方输入框中输入变量总数 N。</span>';
                    if (window.MathJax) {
                       MathJax.typesetPromise([polyOutput]).catch((err) => console.log('MathJax Typeset Error: ' + err.message));
                    }
                }
                return;
            }

            const input = polyInput.value;
            let mode = document.querySelector('input[name="polyMode"]:checked').value;
            
            const result = DealPoly(input, mode);
            
            // 1. 将 DealPoly 的原始结果存入 temp 变量
            temp = result;

            // 2. 更新输出框内容
            polyOutput.innerHTML = result;
            
            // 3. 调用 MathJax 重新渲染该元素
            if (window.MathJax) {
                 MathJax.typesetPromise([polyOutput]).catch((err) => console.log('MathJax Typeset Error: ' + err.message));
            } else {
                 console.error("MathJax object is not available.");
            }
        }
        
        // 核心函数：复制结果
        function copyResult() {
            const copyMode = copyModeSelect.value;
            let textToCopy = "";
            let message = "";

            if (tempPoly === null) {
                alert("请先进行分解以生成结果。");
                return;
            }

            if (copyMode === "latex") {
                // 复制 LaTeX 格式，使用 PolyToTex 确保格式正确
                textToCopy = PolyToTex(tempPoly);
                message = "已复制 $\\LaTeX$ 标记的文本。";
            } else if (copyMode === "raw") {
                // 复制原始代数表达式（假设 tempPoly.toString() 返回所需格式）
                // 注意：如果您的 SPF.js 库未实现 Poly.toString()，这里可能会出错
                textToCopy = tempPoly.toString();
                message = "已复制原始纯文本。";
            } else {
                return;
            }
            
            // 使用 Clipboard API 进行复制
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    // 成功后，更新按钮文字提示
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = '已复制'; 
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                    }, 1500);
                })
                .catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败！请检查浏览器权限。');
                });
        }
        

        // *** 事件监听器 ***
        
        // 1. 模式选择监听器：控制 N 输入框的显示和多项式输入框的启用
        modeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const selectedMode = e.target.value;
                if (selectedMode === '1') {
                    nInputContainer.style.display = 'none';
                    nInput.value = ''; // 清空 N 值
                    updatePolyInputState(); // 模式1直接启用多项式输入
                } else {
                    nInputContainer.style.display = 'flex';
                    updatePolyInputState(); // 模式2/3依赖 N 值
                    // 如果 nInput.value 为空，提示用户输入 N
                    if (nInput.value.trim() === '') {
                        polyOutput.innerHTML = '<span style="color: var(--apple-secondary-text);">请先在上方输入框中输入变量总数 N</span>';
                        if (window.MathJax) {
                           MathJax.typesetPromise([polyOutput]).catch((err) => console.log('MathJax Typeset Error: ' + err.message));
                        }
                    }
                }
            });
        });
        
        // 2. N 输入框监听器：实时控制多项式输入框的启用/禁用
        nInput.addEventListener('input', updatePolyInputState);

        // 3. 按钮和功能监听器
        submitBtn.addEventListener('click', processInput);
        copyBtn.addEventListener('click', copyResult); 

        // 4. 模态框逻辑 (保持不变)
        infoBtn.addEventListener('click', () => {
            infoModal.style.display = 'block';
        });

        closeButton.addEventListener('click', () => {
            infoModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == infoModal) {
                infoModal.style.display = 'none';
            }
        });

        // 初始状态设置：确保多项式输入框根据默认选中的模式（模式1）启用
        updatePolyInputState();
        
    </script>
</body>
</html>